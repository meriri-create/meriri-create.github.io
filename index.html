<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>わたしの記録アプリ</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a1b9a">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #6a1b9a; --secondary-color: #f3e5f5; --accent-color: #ffab00;
            --text-color: #333; --border-color: #ddd; --success-color: #28a745;
            --danger-color: #dc3545; --bg-color: #f9f9f9; --rest-day-bg: #fffaf0;
            --target-line-color: rgba(255, 99, 132, 0.8);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        .container { width: 100%; max-width: 700px; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .screen { display: none; }
        .screen.active { display: block; }
        h1, h2, h3 { text-align: center; }
        h1 { color: var(--primary-color); }
        h2 { color: #555; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-top: 40px;}
        h3 { color: #777; font-size: 1.1em; margin-bottom: 15px;}
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="date"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { resize: vertical; }
        .checkbox-group { display: flex; align-items: center; padding: 10px; background-color: var(--bg-color); border-radius: 8px; margin-bottom: 10px; }
        .checkbox-group label { margin: 0 0 0 10px; font-weight: normal; }
        input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; }
        button {
            width: 100%; padding: 15px; background: linear-gradient(45deg, var(--primary-color), #9c4dcc);
            color: #fff; border: none; border-radius: 8px; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .sub-button { background: #757575; font-size: 14px; padding: 12px; flex-grow: 1; border-radius: 8px; }
        .reset-btn { background: var(--danger-color); margin-top: 10px; }
        .history-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .history-list li { background-color: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--success-color); padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; }
        .history-list li.rest-day { background-color: var(--rest-day-bg); border-left: 5px solid var(--accent-color); }
        .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; width: auto; align-self: center; }
        .record-details { flex-grow: 1; }
        .record-date { font-size: 1.1em; font-weight: bold; color: var(--primary-color); }
        .record-weight, .record-exercise { margin-top: 8px; }
        .record-exercise-memo { margin-top: 5px; font-size: 0.9em; color: #666; background-color: #f0f0f0; padding: 8px; border-radius: 4px; white-space: pre-wrap; }
        .period-mark { color: var(--primary-color); margin-left: 8px; font-style: normal; cursor: help; }
        .chart-container { position: relative; margin: 30px auto; height: 300px; width: 100%; }
        .badge-area { background-color: var(--secondary-color); padding: 20px; border-radius: 12px; margin-top: 25px; }
        #badge-list { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .badge { display: flex; flex-direction: column; align-items: center; width: 100px; padding: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; cursor: help; }
        .badge-icon { font-size: 2.5em; }
        .badge-title { font-size: 0.8em; font-weight: bold; margin-top: 5px; }
        .badge.locked { opacity: 0.4; filter: grayscale(80%); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px 40px 40px; border-radius: 8px; width: 80%; max-width: 700px; position: relative; animation: fadeIn 0.3s; max-height: 85vh; overflow-y: auto; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; }
        .guide h3 { text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-top: 25px; }
        .guide ul { padding-left: 20px; }
        .guide li { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-screen" class="screen">
            <h1>わたしの記録アプリ</h1><h2>ようこそ！</h2><p>ユーザー名を入力してログイン、または新規登録してください。</p><div class="form-group" style="margin-top: 40px;"><label for="login-username">ユーザー名</label><input type="text" id="login-username" placeholder="例: choco_taro"></div><button id="login-btn">ログイン / 新規登録</button>
        </div>
        <div id="setup-screen" class="screen">
            <h2>はじめまして、<span id="setup-username"></span>さん！</h2><p>最初に目標体重を設定しましょう。</p><div class="form-group"><label for="target-weight">目標体重 (kg)</label><input type="number" id="target-weight" step="0.1" placeholder="例: 65.0"></div><button id="save-setup">設定して開始</button>
        </div>
        <div id="main-app" class="screen">
            <h1 id="welcome-message"></h1>
            <p style="text-align:center;">現在の目標: <strong id="display-target-weight"></strong> kg</p>
            <div class="badge-area"><h3>獲得バッジ</h3><div id="badge-list"></div></div>
            <h2>体重の推移グラフ</h2>
            <div class="chart-container"><canvas id="weightChart"></canvas></div>
            <h2>ちょこっと記録</h2>
            <form id="record-form">
                <div class="form-group"><label for="date-input">日付</label><input type="date" id="date-input" required></div>
                <div class="form-group"><label for="weight-input">体重 (kg)</label><input type="number" id="weight-input" step="0.1" placeholder="今日の体重を入力"></div>
                <div class="form-group">
                    <div class="checkbox-group"><input type="checkbox" id="exercise-check"><label for="exercise-check">💪 運動しましたか？</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="period-check"><label for="period-check">🌙 生理日でしたか？</label></div>
                </div>
                <div class="form-group" id="exercise-memo-group" style="display: none;"><label for="exercise-memo">運動内容</label><textarea id="exercise-memo" rows="3" placeholder="例: ジムでマシントレーニング30分"></textarea></div>
                <button type="submit">この内容で記録する</button>
            </form>
            <h2 style="margin-top: 40px;">記録カレンダー</h2>
            <ul id="history-list"></ul>
            <div class="button-group">
                <button id="show-guide-btn" class="sub-button">📖 使い方ガイド</button>
                <button id="edit-target-btn" class="sub-button">🎯 目標を再設定</button>
                <button id="switch-user-btn" class="sub-button">👨‍👩‍👧‍👦 ユーザー切替</button>
            </div>
            <button id="reset-data-btn" class="reset-btn">🗑️ このユーザーの全データをリセット</button>
        </div>
    </div>

    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="guide">
                <h2 style="margin-top: 10px;">『わたしの記録アプリ』使い方ガイド 📖✨</h2>
                <p>このアプリは、あなたの頑張りを「記録」し、「見える化」し、「楽しく」続けるための、あなただけの健康管理アプリです。</p><hr>
                <h3>🚀 ステップ1：最初の設定</h3>
                <ul><li><strong>ユーザー登録:</strong> 最初にあなたの好きなユーザー名を入力してスタートします。</li><li><strong>目標体重の設定:</strong> 次に、あなたの目標体重を決めます。この目標は後からいつでも変更できます。</li></ul>
                <h3>✍️ ステップ2：毎日の記録</h3>
                <p>「ちょこっと記録」エリアで、以下の項目を入力して紫色の「記録する」ボタンを押します。</p>
                <ul><li><strong>体重:</strong> その日の体重を入力します。</li><li><strong>運動 `💪`:</strong> 運動したらチェックを入れ、内容をメモできます。</li><li><strong>生理日 `🌙`:</strong> 生理日であれば、ここにチェックを入れます。</li></ul>
                <h3>📊 ステップ3：自分の頑張りを振り返る</h3>
                <ul><li><strong>獲得バッジ `🏆`:</strong> あなたの頑張りに応じて、様々なバッジがもらえます！</li><li><strong>体重の推移グラフ `📈`:</strong> 体重の変化（紫の線）と目標（赤い点線）が一目でわかります。</li><li><strong>記録カレンダー `🗓️`:</strong> 過去の記録が一覧で表示されます。生理日には `🌙` マークがつきます。</li></ul>
                <h3>⚙️ ステップ4：便利な機能</h3>
                <ul><li><strong>目標を再設定 `🎯`:</strong> ボタン一つで、いつでも目標体重を変更できます。</li><li><strong>ユーザー切替 `👨‍👩‍👧‍👦`:</strong> 家族で使う場合、このボタンでログイン画面に戻り、ユーザーを切り替えられます。</li></ul>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const screens = { login: document.getElementById('login-screen'), setup: document.getElementById('setup-screen'), main: document.getElementById('main-app') };
        const loginUsernameInput = document.getElementById('login-username'); const loginBtn = document.getElementById('login-btn');
        const setupUsernameSpan = document.getElementById('setup-username'); const targetWeightInput = document.getElementById('target-weight'); const saveSetupBtn = document.getElementById('save-setup');
        const welcomeMessage = document.getElementById('welcome-message'); const recordForm = document.getElementById('record-form');
        const dateInput = document.getElementById('date-input'); const weightInput = document.getElementById('weight-input');
        const exerciseCheck = document.getElementById('exercise-check'); const exerciseMemoGroup = document.getElementById('exercise-memo-group');
        const exerciseMemo = document.getElementById('exercise-memo'); const historyList = document.getElementById('history-list');
        const switchUserBtn = document.getElementById('switch-user-btn'); const resetDataBtn = document.getElementById('reset-data-btn');
        const badgeList = document.getElementById('badge-list'); const chartCanvas = document.getElementById('weightChart');
        const displayTargetWeight = document.getElementById('display-target-weight'); const editTargetBtn = document.getElementById('edit-target-btn');
        const periodCheck = document.getElementById('period-check');
        const guideModal = document.getElementById('guide-modal'); const showGuideBtn = document.getElementById('show-guide-btn'); const closeBtn = document.querySelector('.close-btn');
        let weightChart = null; let currentUser = null; let allUsersData = {};
        
        const badges = {
            firstStep: { title: 'はじめの一歩', description: '最初の記録を達成！', icon: '👟' }, record7: { title: '継続の週間', description: '累計7日間の記録を達成！', icon: '🗓️' },
            record30: { title: '習慣の達人', description: '累計30日間の記録を達成！', icon: '🌟' }, weightLoss1: { title: 'ナイスファイト', description: '初めて1kg以上の減量に成功！', icon: '💪' },
            targetAchieved: { title: '目標達成', description: '目標体重に到達！おめでとう！', icon: '🎉' }
        };

        function showScreen(screenName) { Object.values(screens).forEach(s=>s.classList.remove('active')); if(screens[screenName]) screens[screenName].classList.add('active'); }
        function loadAllData() { allUsersData = JSON.parse(localStorage.getItem('myHealthRecordApp_v1')) || {}; }
        function saveAllData() { localStorage.setItem('myHealthRecordApp_v1', JSON.stringify(allUsersData)); }

        function initializeApp() { loadAllData(); showScreen('login'); }
        
        loginBtn.addEventListener('click', () => {
            const username = loginUsernameInput.value.trim().toLowerCase(); if (!username) { alert('ユーザー名を入力してください。'); return; }
            currentUser = username; if (allUsersData[currentUser]) { showMainApp(); } else { showSetupScreen(); }
        });
        function showSetupScreen() { setupUsernameSpan.textContent = currentUser; targetWeightInput.value = ''; showScreen('setup'); }
        saveSetupBtn.addEventListener('click', () => {
            const targetWeight = parseFloat(targetWeightInput.value); if (!targetWeight || targetWeight <= 0) { alert('有効な目標体重を入力してください。'); return; }
            allUsersData[currentUser] = { settings: { targetWeight: targetWeight }, records: {}, badges: {} };
            saveAllData(); showMainApp();
        });
        
        function showMainApp() {
            if (!currentUser || !allUsersData[currentUser]) { initializeApp(); return; }
            welcomeMessage.textContent = `${currentUser}の記録`;
            dateInput.value = new Date().toISOString().split('T')[0];
            loadRecordForDate(dateInput.value);
            renderAll();
            showScreen('main');
        }

        function renderAll() {
            if (!currentUser || !allUsersData[currentUser]) return;
            displayTargetWeight.textContent = parseFloat(allUsersData[currentUser].settings.targetWeight).toFixed(1);
            renderHistory();
            renderBadges();
            renderWeightChart();
        }
        
        dateInput.addEventListener('change', () => loadRecordForDate(dateInput.value));
        exerciseCheck.addEventListener('change', () => exerciseMemoGroup.style.display = exerciseCheck.checked ? 'block' : 'none');

        function loadRecordForDate(date) {
            const record = allUsersData[currentUser]?.records[date];
            weightInput.value = record?.weight || ''; exerciseCheck.checked = record?.didExercise || false;
            periodCheck.checked = record?.isPeriod || false;
            exerciseMemo.value = record?.exerciseMemo || '';
            exerciseMemoGroup.style.display = exerciseCheck.checked ? 'block' : 'none';
        }

        recordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const date = dateInput.value; const weight = weightInput.value ? parseFloat(weightInput.value) : null;
            const didExercise = exerciseCheck.checked; const isPeriod = periodCheck.checked;
            const memo = exerciseMemo.value.trim();
            if (!date || (weight === null && !didExercise && !isPeriod)) { alert('日付を入力し、体重、運動、生理日のいずれかを記録してください。'); return; }
            allUsersData[currentUser].records[date] = { weight, didExercise, exerciseMemo: memo, isPeriod };
            checkAndAwardBadges(); saveAllData(); renderAll();
            alert('記録しました！');
        });

        function renderHistory() {
            historyList.innerHTML = ''; if (!allUsersData[currentUser]) return;
            const records = allUsersData[currentUser].records; const sortedDates = Object.keys(records).sort((a, b) => new Date(b) - new Date(a));
            if (sortedDates.length === 0) { historyList.innerHTML = '<li>記録はまだありません。</li>'; return; }
            sortedDates.forEach(date => {
                const record = records[date]; if (record.weight === null && !record.didExercise && !record.isPeriod) return;
                const li = document.createElement('li');
                if (record.didExercise) { li.classList.remove('rest-day'); } else { li.classList.add('rest-day'); }
                const periodMark = record.isPeriod ? `<i class="period-mark" title="生理日">🌙</i>` : '';
                const dateHTML = `<div class="record-date">${date}${periodMark}</div>`;
                const weightHTML = record.weight ? `<div class="record-weight">⚖️ 体重: <strong>${record.weight.toFixed(1)} kg</strong></div>` : '';
                let exerciseHTML = '';
                if (record.didExercise) {
                    exerciseHTML = `<div class="record-exercise">💪 運動しました</div>`;
                    if (record.exerciseMemo) { exerciseHTML += `<div class="record-exercise-memo">${record.exerciseMemo.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`; }
                } else if (!record.isPeriod) { exerciseHTML = `<div class="record-exercise" style="color: #888;">🛌 運動: おやすみ</div>`; }
                li.innerHTML = `<div class="record-details">${dateHTML}${weightHTML}${exerciseHTML}</div><button class="delete-btn" data-date="${date}">削除</button>`;
                historyList.appendChild(li);
            });
        }
        
        function checkAndAwardBadges(){const e=allUsersData[currentUser],t=e.records,r=e.badges||{};let a=!1;const n=(e,t)=>{!r[e]&&t&&(r[e]=!0,a=!0,setTimeout(()=>alert(`🎉 新しいバッジ【${badges[e].title}】を獲得しました！`),100))};const o=Object.keys(t).length;n("firstStep",o>=1),n("record7",o>=7),n("record30",o>=30);const s=Object.values(t).map(e=>e.weight).filter(e=>null!=e);s.length>1&&(n("weightLoss1",s[0]-s[s.length-1]>=1),n("targetAchieved",s[s.length-1]<=e.settings.targetWeight)),e.badges=r}
        function renderBadges(){badgeList.innerHTML="";const e=allUsersData[currentUser]?.badges||{};for(const t in badges){const r=badges[t],a=document.createElement("div");a.classList.add("badge"),e[t]||a.classList.add("locked"),a.title=r.description,a.innerHTML=`<span class="badge-icon">${r.icon}</span><span class="badge-title">${r.title}</span>`,badgeList.appendChild(a)}}
        function renderWeightChart() {
            const userData = allUsersData[currentUser]; if (!userData) return;
            const records = userData.records || {}; const targetWeight = userData.settings.targetWeight;
            const sortedDates = Object.keys(records).sort((a, b) => new Date(a) - new Date(b));
            const labels = []; const dataPoints = [];
            sortedDates.forEach(date => { if (records[date].weight != null) { labels.push(date); dataPoints.push(records[date].weight); } });
            if (weightChart) { weightChart.destroy(); }
            weightChart = new Chart(chartCanvas, {
                type: 'line', data: { labels: labels, datasets: [ { label: '体重 (kg)', data: dataPoints, borderColor: 'rgba(106, 27, 154, 0.8)', backgroundColor: 'rgba(106, 27, 154, 0.1)', fill: true, tension: 0.1 }, { label: '目標体重', data: Array(labels.length).fill(targetWeight), borderColor: 'var(--target-line-color)', borderDash: [5, 5], pointRadius: 0, fill: false, borderWidth: 2 } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
            });
        }
        
        editTargetBtn.addEventListener('click', () => {
            const currentTarget = allUsersData[currentUser].settings.targetWeight;
            const newTargetStr = prompt('新しい目標体重(kg)を入力してください。', currentTarget);
            if (newTargetStr === null) return;
            const newTarget = parseFloat(newTargetStr);
            if (!isNaN(newTarget) && newTarget > 0) {
                allUsersData[currentUser].settings.targetWeight = newTarget; saveAllData(); renderAll();
                alert(`目標体重を ${newTarget.toFixed(1)} kg に更新しました！`);
            } else { alert('無効な数値です。正しい体重を入力してください。'); }
        });
        historyList.addEventListener('click', e => { if (e.target.classList.contains('delete-btn')) { const dateToDelete = e.target.dataset.date; if (confirm(`${dateToDelete}の記録を削除しますか？`)) { delete allUsersData[currentUser].records[dateToDelete]; saveAllData(); loadRecordForDate(dateInput.value); renderAll(); } } });
        switchUserBtn.addEventListener('click', () => { if (confirm('ユーザーを切り替えますか？')) { currentUser = null; loginUsernameInput.value = ''; showScreen('login'); } });
        resetDataBtn.addEventListener('click', () => { if (confirm(`本当にユーザー「${currentUser}」のすべてのデータを削除しますか？この操作は元に戻せません。`)) { delete allUsersData[currentUser]; saveAllData(); currentUser = null; loginUsernameInput.value = ''; showScreen('login'); } });

        showGuideBtn.addEventListener('click', () => { guideModal.style.display = 'block'; });
        closeBtn.addEventListener('click', () => { guideModal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == guideModal) { guideModal.style.display = 'none'; } });

        initializeApp();
    });
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js');
        });
      }
    </script>
</body>
</html>