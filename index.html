<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãŸã—ã®è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a1b9a">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #6a1b9a; --secondary-color: #f3e5f5; --accent-color: #ffab00;
            --text-color: #333; --border-color: #ddd; --success-color: #28a745;
            --danger-color: #dc3545; --bg-color: #f9f9f9; --rest-day-bg: #fffaf0;
            --target-line-color: rgba(255, 99, 132, 0.8);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { width: 100%; max-width: 700px; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .screen { display: none; }
        .screen.active { display: block; }
        h1, h2, h3 { text-align: center; }
        h1 { color: var(--primary-color); }
        h2 { color: #555; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-top: 40px;}
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { resize: vertical; }
        .checkbox-group { display: flex; align-items: center; padding: 10px; background-color: var(--bg-color); border-radius: 8px; margin-bottom: 10px; }
        .checkbox-group label { margin: 0 0 0 10px; font-weight: normal; }
        input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; }
        button { width: 100%; padding: 15px; background: linear-gradient(45deg, var(--primary-color), #9c4dcc); color: #fff; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .sub-button { background: #757575; font-size: 14px; padding: 12px; flex-grow: 1; border-radius: 8px; }
        .reset-btn { background: var(--danger-color); margin-top: 10px; }
        .history-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .history-list li { background-color: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--success-color); padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; }
        .history-list li.rest-day { background-color: var(--rest-day-bg); border-left: 5px solid var(--accent-color); }
        .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; width: auto; align-self: center; }
        .record-details { flex-grow: 1; }
        .record-date { font-size: 1.1em; font-weight: bold; color: var(--primary-color); }
        .record-weight, .record-exercise { margin-top: 8px; }
        .record-exercise-memo { margin-top: 5px; font-size: 0.9em; color: #666; background-color: #f0f0f0; padding: 8px; border-radius: 4px; white-space: pre-wrap; }
        .period-mark { color: var(--primary-color); margin-left: 8px; font-style: normal; cursor: help; }
        .chart-container { position: relative; margin: 30px auto; height: 300px; width: 100%; }
        .badge-area { background-color: var(--secondary-color); padding: 20px; border-radius: 12px; margin-top: 25px; }
        #badge-list { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .badge { display: flex; flex-direction: column; align-items: center; width: 100px; padding: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; cursor: help; }
        .badge-icon { font-size: 2.5em; }
        .badge-title { font-size: 0.8em; font-weight: bold; margin-top: 5px; }
        .badge.locked { opacity: 0.4; filter: grayscale(80%); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px 40px 40px; border-radius: 8px; width: 80%; max-width: 700px; position: relative; animation: fadeIn 0.3s; max-height: 85vh; overflow-y: auto; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; }
        .guide h3 { text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-top: 25px; }
        .guide ul { padding-left: 20px; }
        .guide li { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-screen" class="screen">
            <h1>ã‚ãŸã—ã®è¨˜éŒ²ã‚¢ãƒ—ãƒª</h1><h2>ã‚ˆã†ã“ãï¼</h2>
            <div class="form-group"><label for="login-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" id="login-email" placeholder="email@example.com" autocomplete="email"></div>
            <div class="form-group"><label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="login-password" placeholder="6æ–‡å­—ä»¥ä¸Š" autocomplete="current-password"></div>
            <div class="button-group">
                <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="signup-btn" class="sub-button">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</button>
            </div>
        </div>

        <div id="setup-screen" class="screen">
            <h2>ã‚ˆã†ã“ãï¼</h2><p>æœ€åˆã«ç›®æ¨™ä½“é‡ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚</p>
            <div class="form-group"><label for="target-weight">ç›®æ¨™ä½“é‡ (kg)</label><input type="number" id="target-weight" step="0.1" placeholder="ä¾‹: 65.0"></div>
            <button id="save-setup-btn">è¨­å®šã—ã¦é–‹å§‹</button>
        </div>

        <div id="main-app" class="screen">
            <h1 id="welcome-message"></h1>
            <p style="text-align:center;">ç¾åœ¨ã®ç›®æ¨™: <strong id="display-target-weight"></strong> kg</p>
            <div class="badge-area"><h3>ç²å¾—ãƒãƒƒã‚¸</h3><div id="badge-list"></div></div>
            <h2>ä½“é‡ã®æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
            <div class="chart-container"><canvas id="weightChart"></canvas></div>
            <h2>ã¡ã‚‡ã“ã£ã¨è¨˜éŒ²</h2>
            <form id="record-form">
                <div class="form-group"><label for="date-input">æ—¥ä»˜</label><input type="date" id="date-input" required></div>
                <div class="form-group"><label for="weight-input">ä½“é‡ (kg)</label><input type="number" id="weight-input" step="0.1" placeholder="ä»Šæ—¥ã®ä½“é‡ã‚’å…¥åŠ›"></div>
                <div class="form-group">
                    <div class="checkbox-group"><input type="checkbox" id="exercise-check"><label for="exercise-check">ğŸ’ª é‹å‹•ã—ã¾ã—ãŸã‹ï¼Ÿ</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="period-check"><label for="period-check">ğŸŒ™ ç”Ÿç†æ—¥ã§ã—ãŸã‹ï¼Ÿ</label></div>
                </div>
                <div class="form-group" id="exercise-memo-group" style="display: none;"><label for="exercise-memo">é‹å‹•å†…å®¹</label><textarea id="exercise-memo" rows="3" placeholder="ä¾‹: ã‚¸ãƒ ã§ãƒã‚·ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°30åˆ†"></textarea></div>
                <button type="submit">ã“ã®å†…å®¹ã§è¨˜éŒ²ã™ã‚‹</button>
            </form>
            <h2 style="margin-top: 40px;">è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
            <ul id="history-list"></ul>
            <div class="button-group">
                <button id="show-guide-btn" class="sub-button">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</button>
                <button id="edit-target-btn" class="sub-button">ğŸ¯ ç›®æ¨™ã‚’å†è¨­å®š</button>
                <button id="logout-btn" class="sub-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <button id="reset-data-btn" class="reset-btn">ğŸ—‘ï¸ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>
    
    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="guide">
                <h2 style="margin-top: 10px;">ã€ã‚ãŸã—ã®è¨˜éŒ²ã‚¢ãƒ—ãƒªã€ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ ğŸ“–âœ¨</h2>
                <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚ãªãŸã®é ‘å¼µã‚Šã‚’ã€Œè¨˜éŒ²ã€ã—ã€ã€Œè¦‹ãˆã‚‹åŒ–ã€ã—ã€ã€Œæ¥½ã—ãã€ç¶šã‘ã‚‹ãŸã‚ã®ã€ã‚ãªãŸã ã‘ã®å¥åº·ç®¡ç†ã‚¢ãƒ—ãƒªã§ã™ã€‚</p><hr>
                <h3>ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—1ï¼šæœ€åˆã®è¨­å®š</h3>
                <ul><li><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²:</strong> ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨6æ–‡å­—ä»¥ä¸Šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æ–°è¦ç™»éŒ²ã—ã¾ã™ã€‚</li><li><strong>ç›®æ¨™ä½“é‡ã®è¨­å®š:</strong> æ¬¡ã«ã€ã‚ãªãŸã®ç›®æ¨™ä½“é‡ã‚’æ±ºã‚ã¾ã™ã€‚ã“ã®ç›®æ¨™ã¯å¾Œã‹ã‚‰ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ã€‚</li></ul>
                <h3>âœï¸ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šæ¯æ—¥ã®è¨˜éŒ²</h3>
                <p>ã€Œã¡ã‚‡ã“ã£ã¨è¨˜éŒ²ã€ã‚¨ãƒªã‚¢ã§ã€ä»¥ä¸‹ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ç´«è‰²ã®ã€Œè¨˜éŒ²ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</p>
                <ul><li><strong>ä½“é‡:</strong> ãã®æ—¥ã®ä½“é‡ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li><li><strong>é‹å‹• `ğŸ’ª`:</strong> é‹å‹•ã—ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€å†…å®¹ã‚’ãƒ¡ãƒ¢ã§ãã¾ã™ã€‚</li><li><strong>ç”Ÿç†æ—¥ `ğŸŒ™`:</strong> ç”Ÿç†æ—¥ã§ã‚ã‚Œã°ã€ã“ã“ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã€‚</li></ul>
                <h3>ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—3ï¼šè‡ªåˆ†ã®é ‘å¼µã‚Šã‚’æŒ¯ã‚Šè¿”ã‚‹</h3>
                <ul><li><strong>ç²å¾—ãƒãƒƒã‚¸ `ğŸ†`:</strong> ã‚ãªãŸã®é ‘å¼µã‚Šã«å¿œã˜ã¦ã€æ§˜ã€…ãªãƒãƒƒã‚¸ãŒã‚‚ã‚‰ãˆã¾ã™ï¼</li><li><strong>ä½“é‡ã®æ¨ç§»ã‚°ãƒ©ãƒ• `ğŸ“ˆ`:</strong> ä½“é‡ã®å¤‰åŒ–ï¼ˆç´«ã®ç·šï¼‰ã¨ç›®æ¨™ï¼ˆèµ¤ã„ç‚¹ç·šï¼‰ãŒä¸€ç›®ã§ã‚ã‹ã‚Šã¾ã™ã€‚</li><li><strong>è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ `ğŸ—“ï¸`:</strong> éå»ã®è¨˜éŒ²ãŒä¸€è¦§ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ç”Ÿç†æ—¥ã«ã¯ `ğŸŒ™` ãƒãƒ¼ã‚¯ãŒã¤ãã¾ã™ã€‚</li></ul>
                <h3>âš™ï¸ ã‚¹ãƒ†ãƒƒãƒ—4ï¼šä¾¿åˆ©ãªæ©Ÿèƒ½</h3>
                <ul><li><strong>ç›®æ¨™ã‚’å†è¨­å®š `ğŸ¯`:</strong> ãƒœã‚¿ãƒ³ä¸€ã¤ã§ã€ã„ã¤ã§ã‚‚ç›®æ¨™ä½“é‡ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</li><li><strong>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ:</strong> ä½¿ã„çµ‚ã‚ã£ãŸã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã¾ã™ã€‚</li></ul>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebaseã®åˆæœŸåŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyDn3Gm8M0tVHSof3UdZjZ6P2NpQEo6Sj_U",
            authDomain: "mydata-75f6a.firebaseapp.com",
            projectId: "mydata-75f6a",
            storageBucket: "mydata-75f6a.appspot.com",
            messagingSenderId: "109261190862",
            appId: "1:109261190862:web:084db3782e289890fb429f"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOMè¦ç´ ã®å–å¾— ---
        const screens = { login: document.getElementById('login-screen'), setup: document.getElementById('setup-screen'), main: document.getElementById('main-app') };
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const saveSetupBtn = document.getElementById('save-setup-btn');
        const targetWeightInput = document.getElementById('target-weight');
        const welcomeMessage = document.getElementById('welcome-message');
        const displayTargetWeight = document.getElementById('display-target-weight');
        const recordForm = document.getElementById('record-form');
        const dateInput = document.getElementById('date-input');
        const weightInput = document.getElementById('weight-input');
        const exerciseCheck = document.getElementById('exercise-check');
        const periodCheck = document.getElementById('period-check');
        const exerciseMemoGroup = document.getElementById('exercise-memo-group');
        const exerciseMemo = document.getElementById('exercise-memo');
        const historyList = document.getElementById('history-list');
        const badgeList = document.getElementById('badge-list');
        const chartCanvas = document.getElementById('weightChart');
        const editTargetBtn = document.getElementById('edit-target-btn');
        const resetDataBtn = document.getElementById('reset-data-btn');
        const guideModal = document.getElementById('guide-modal');
        const showGuideBtn = document.getElementById('show-guide-btn');
        const closeBtn = document.querySelector('.close-btn');
        
        let weightChart = null;
        let currentUser = null;
        let dailyRecords = {};
        let userSettings = {};
        let userBadges = {};

        const badges = {
            firstStep: { title: 'ã¯ã˜ã‚ã®ä¸€æ­©', description: 'æœ€åˆã®è¨˜éŒ²ã‚’é”æˆï¼', icon: 'ğŸ‘Ÿ' }, record7: { title: 'ç¶™ç¶šã®é€±é–“', description: 'ç´¯è¨ˆ7æ—¥é–“ã®è¨˜éŒ²ã‚’é”æˆï¼', icon: 'ğŸ—“ï¸' },
            record30: { title: 'ç¿’æ…£ã®é”äºº', description: 'ç´¯è¨ˆ30æ—¥é–“ã®è¨˜éŒ²ã‚’é”æˆï¼', icon: 'ğŸŒŸ' }, weightLoss1: { title: 'ãƒŠã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒˆ', description: 'åˆã‚ã¦1kgä»¥ä¸Šã®æ¸›é‡ã«æˆåŠŸï¼', icon: 'ğŸ’ª' },
            targetAchieved: { title: 'ç›®æ¨™é”æˆ', description: 'ç›®æ¨™ä½“é‡ã«åˆ°é”ï¼ãŠã‚ã§ã¨ã†ï¼', icon: 'ğŸ‰' }
        };

        function showScreen(screenName) { Object.values(screens).forEach(s=>s.classList.remove('active')); if(screens[screenName]) screens[screenName].classList.add('active'); }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    userSettings = data.settings || {};
                    userBadges = data.badges || {};
                    await loadRecordsFromFirestore();
                    showMainApp();
                } else {
                    showScreen('setup');
                }
            } else {
                currentUser = null;
                showScreen('login');
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) { alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + error.message); }
        });

        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) { alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + error.message); }
        });
        
        logoutBtn.addEventListener('click', () => { if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { auth.signOut(); } });

        saveSetupBtn.addEventListener('click', async () => {
            const targetWeight = parseFloat(targetWeightInput.value);
            if (currentUser && targetWeight > 0) {
                userSettings = { targetWeight: targetWeight };
                userBadges = {};
                await db.collection('users').doc(currentUser.uid).set({ settings: userSettings, badges: userBadges });
                await loadRecordsFromFirestore();
                showMainApp();
            } else { alert('æœ‰åŠ¹ãªç›®æ¨™ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); }
        });
        
        async function loadRecordsFromFirestore() {
            if (!currentUser) return;
            const recordsSnapshot = await db.collection('users').doc(currentUser.uid).collection('records').get();
            dailyRecords = {};
            recordsSnapshot.forEach(doc => { dailyRecords[doc.id] = doc.data(); });
        }
        
        function showMainApp() {
            if (!currentUser) return;
            welcomeMessage.textContent = (currentUser.email || 'ã‚²ã‚¹ãƒˆ') + 'ã®è¨˜éŒ²';
            dateInput.value = new Date().toISOString().split('T')[0];
            loadRecordForDate(dateInput.value);
            renderAll();
            showScreen('main');
        }

        function renderAll() {
            if (!currentUser) return;
            displayTargetWeight.textContent = parseFloat(userSettings.targetWeight || 0).toFixed(1);
            renderHistory();
            renderBadges();
            renderWeightChart();
        }
        
        dateInput.addEventListener('change', () => loadRecordForDate(dateInput.value));
        exerciseCheck.addEventListener('change', () => exerciseMemoGroup.style.display = exerciseCheck.checked ? 'block' : 'none');

        function loadRecordForDate(date) {
            const record = dailyRecords[date];
            weightInput.value = record?.weight || '';
            exerciseCheck.checked = record?.didExercise || false;
            periodCheck.checked = record?.isPeriod || false;
            exerciseMemo.value = record?.exerciseMemo || '';
            exerciseMemoGroup.style.display = exerciseCheck.checked ? 'block' : 'none';
        }

        recordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const date = dateInput.value;
            const recordData = {
                weight: weightInput.value ? parseFloat(weightInput.value) : null,
                didExercise: exerciseCheck.checked, isPeriod: periodCheck.checked,
                exerciseMemo: exerciseMemo.value.trim()
            };
            if (!date || (recordData.weight === null && !recordData.didExercise && !recordData.isPeriod)) {
                alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã€ä½“é‡ã€é‹å‹•ã€ç”Ÿç†æ—¥ã®ã„ãšã‚Œã‹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚'); return;
            }
            try {
                await db.collection('users').doc(currentUser.uid).collection('records').doc(date).set(recordData, { merge: true });
                dailyRecords[date] = recordData;
                await checkAndAwardBadges();
                renderAll();
                alert('è¨˜éŒ²ã—ã¾ã—ãŸï¼');
            } catch (error) { alert("è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message); }
        });

        function renderHistory() {
            historyList.innerHTML = ''; if (!currentUser) return;
            const sortedDates = Object.keys(dailyRecords).sort((a, b) => new Date(b) - new Date(a));
            if (sortedDates.length === 0) { historyList.innerHTML = '<li>è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; return; }
            sortedDates.forEach(date => {
                const record = dailyRecords[date];
                const li = document.createElement('li');
                li.classList.toggle('rest-day', !record.didExercise);
                const periodMark = record.isPeriod ? `<i class="period-mark" title="ä½“èª¿è¨˜éŒ²æ—¥">ğŸŒ™</i>` : '';
                const dateHTML = `<div class="record-date">${date}${periodMark}</div>`;
                const weightHTML = record.weight ? `<div class="record-weight">âš–ï¸ ä½“é‡: <strong>${record.weight.toFixed(1)} kg</strong></div>` : '';
                let exerciseHTML = '';
                if (record.didExercise) {
                    exerciseHTML = `<div class="record-exercise">ğŸ’ª é‹å‹•ã—ã¾ã—ãŸ</div>`;
                    if (record.exerciseMemo) exerciseHTML += `<div class="record-exercise-memo">${record.exerciseMemo.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`;
                } else if (!record.isPeriod) { exerciseHTML = `<div class="record-exercise" style="color: #888;">ğŸ›Œ é‹å‹•: ãŠã‚„ã™ã¿</div>`; }
                li.innerHTML = `<div class="record-details">${dateHTML}${weightHTML}${exerciseHTML}</div><button class="delete-btn" data-date="${date}">å‰Šé™¤</button>`;
                historyList.appendChild(li);
            });
        }
        
        async function checkAndAwardBadges(){
            if (!currentUser) return;
            let newBadgeAwarded = false;
            const checkAndSetBadge = (badgeId, condition) => {
                if (!userBadges[badgeId] && condition) {
                    userBadges[badgeId] = true; newBadgeAwarded = true;
                    setTimeout(()=>alert(`ğŸ‰ æ–°ã—ã„ãƒãƒƒã‚¸ã€${badges[badgeId].title}ã€‘ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`), 100);
                }
            };
            const recordCount = Object.keys(dailyRecords).length;
            checkAndSetBadge('firstStep', recordCount >= 1);
            checkAndSetBadge('record7', recordCount >= 7);
            checkAndSetBadge('record30', recordCount >= 30);
            const weights = Object.values(dailyRecords).map(r => r.weight).filter(w => w != null);
            if (weights.length > 0) {
                const initialWeights = Object.entries(dailyRecords).filter(([,r])=>r.weight!=null).sort((a,b)=>new Date(a[0])-new Date(b[0]));
                const initialWeight = initialWeights[0][1].weight;
                const latestWeight = weights[weights.length - 1];
                checkAndSetBadge('weightLoss1', initialWeight - latestWeight >= 1);
                checkAndSetBadge('targetAchieved', latestWeight <= userSettings.targetWeight);
            }
            if(newBadgeAwarded){ await db.collection('users').doc(currentUser.uid).update({ badges: userBadges }); }
        }
        function renderBadges(){
            badgeList.innerHTML="";
            for(const t in badges){const r=badges[t],a=document.createElement("div");a.classList.add("badge"),userBadges[t]||a.classList.add("locked"),a.title=r.description,a.innerHTML=`<span class="badge-icon">${r.icon}</span><span class="badge-title">${r.title}</span>`,badgeList.appendChild(a)}
        }
        function renderWeightChart() {
            if (!currentUser) return;
            const targetWeight = userSettings.targetWeight;
            const sortedDates = Object.keys(dailyRecords).sort((a, b) => new Date(a) - new Date(b));
            const labels = []; const dataPoints = [];
            sortedDates.forEach(date => { if (dailyRecords[date].weight != null) { labels.push(date); dataPoints.push(dailyRecords[date].weight); } });
            if (weightChart) { weightChart.destroy(); }
            weightChart = new Chart(chartCanvas, {
                type: 'line', data: { labels: labels, datasets: [ { label: 'ä½“é‡ (kg)', data: dataPoints, borderColor: 'rgba(106, 27, 154, 0.8)', backgroundColor: 'rgba(106, 27, 154, 0.1)', fill: true, tension: 0.1 }, { label: 'ç›®æ¨™ä½“é‡', data: Array(labels.length).fill(targetWeight), borderColor: 'var(--target-line-color)', borderDash: [5, 5], pointRadius: 0, fill: false, borderWidth: 2 } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
            });
        }
        
        editTargetBtn.addEventListener('click', async () => {
            const currentTarget = userSettings.targetWeight;
            const newTargetStr = prompt('æ–°ã—ã„ç›®æ¨™ä½“é‡(kg)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', currentTarget);
            if (newTargetStr === null) return;
            const newTarget = parseFloat(newTargetStr);
            if (!isNaN(newTarget) && newTarget > 0) {
                userSettings.targetWeight = newTarget;
                await db.collection('users').doc(currentUser.uid).update({ 'settings.targetWeight': newTarget });
                renderAll();
                alert(`ç›®æ¨™ä½“é‡ã‚’ ${newTarget.toFixed(1)} kg ã«æ›´æ–°ã—ã¾ã—ãŸï¼`);
            } else { alert('ç„¡åŠ¹ãªæ•°å€¤ã§ã™ã€‚æ­£ã—ã„ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); }
        });
        historyList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const dateToDelete = e.target.dataset.date;
                if (confirm(`${dateToDelete}ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    await db.collection('users').doc(currentUser.uid).collection('records').doc(dateToDelete).delete();
                    delete dailyRecords[dateToDelete];
                    renderAll();
                }
            }
        });
        resetDataBtn.addEventListener('click', async () => {
            if (confirm(`æœ¬å½“ã«ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                if(!currentUser) return;
                const recordsRef = db.collection('users').doc(currentUser.uid).collection('records');
                const snapshot = await recordsRef.get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await db.collection('users').doc(currentUser.uid).update({badges: {}});
                dailyRecords = {}; userBadges = {};
                renderAll();
                alert('å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
            }
        });
        showGuideBtn.addEventListener('click', () => { guideModal.style.display = 'block'; });
        closeBtn.addEventListener('click', () => { guideModal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == guideModal) { guideModal.style.display = 'none'; } });

        initializeApp();
    });
    </script>
</body>
</html>