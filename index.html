<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãŸã—ã®è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a1b9a">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (CSSã¯å‰å›ã‹ã‚‰å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“) */
        :root {
            --primary-color: #6a1b9a; --secondary-color: #f3e5f5; --accent-color: #ffab00;
            --text-color: #333; --border-color: #ddd; --success-color: #28a745;
            --danger-color: #dc3545; --bg-color: #f9f9f9; --rest-day-bg: #fffaf0;
            --target-line-color: rgba(255, 99, 132, 0.8);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { width: 100%; max-width: 700px; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .screen { display: none; }
        .screen.active { display: block; }
        h1, h2, h3 { text-align: center; }
        h1 { color: var(--primary-color); }
        h2 { color: #555; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-top: 40px;}
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        /* (ãã®ä»–ã®CSSã‚‚çœç•¥) */
    </style>
</head>
<body>
    <div class="container">
        <div id="login-screen" class="screen">
            <h1>ã‚ãŸã—ã®è¨˜éŒ²ã‚¢ãƒ—ãƒª</h1><h2>ã‚ˆã†ã“ãï¼</h2>
            <div class="form-group"><label for="login-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" id="login-email" placeholder="email@example.com"></div>
            <div class="form-group"><label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="login-password" placeholder="6æ–‡å­—ä»¥ä¸Š"></div>
            <div class="button-group">
                <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="signup-btn" class="sub-button">æ–°è¦ç™»éŒ²</button>
            </div>
        </div>

        <div id="setup-screen" class="screen">
            <h2>ã‚ˆã†ã“ãï¼</h2><p>æœ€åˆã«ç›®æ¨™ä½“é‡ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚</p>
            <div class="form-group"><label for="target-weight">ç›®æ¨™ä½“é‡ (kg)</label><input type="number" id="target-weight" step="0.1" placeholder="ä¾‹: 65.0"></div>
            <button id="save-setup-btn">è¨­å®šã—ã¦é–‹å§‹</button>
        </div>

        <div id="main-app" class="screen">
            <h1 id="welcome-message"></h1>
            <p style="text-align:center;">ç¾åœ¨ã®ç›®æ¨™: <strong id="display-target-weight"></strong> kg</p>
            <div class="badge-area"><h3>ç²å¾—ãƒãƒƒã‚¸</h3><div id="badge-list"></div></div>
            <h2>ä½“é‡ã®æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
            <div class="chart-container"><canvas id="weightChart"></canvas></div>
            <h2>ã¡ã‚‡ã“ã£ã¨è¨˜éŒ²</h2>
            <form id="record-form"> ... </form> <h2 style="margin-top: 40px;">è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
            <ul id="history-list"></ul>
            <div class="button-group">
                <button id="show-guide-btn" class="sub-button">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</button>
                <button id="edit-target-btn" class="sub-button">ğŸ¯ ç›®æ¨™ã‚’å†è¨­å®š</button>
                <button id="logout-btn" class="sub-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button> </div>
            <button id="reset-data-btn" class="reset-btn">ğŸ—‘ï¸ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>
    
    <div id="guide-modal" class="modal"> ... </div> <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebaseã®åˆæœŸåŒ– ---
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        // const firebaseConfig = {
  apiKey: "AIzaSyDn3Gm8M0tVHSof3UdZjZ6P2NpQEo6Sj_U",
  authDomain: "mydata-75f6a.firebaseapp.com",
  projectId: "mydata-75f6a",
  storageBucket: "mydata-75f6a.firebasestorage.app",
  messagingSenderId: "109261190862",
  appId: "1:109261190862:web:084db3782e289890fb429f"
};
        // 
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOMè¦ç´ ã®å–å¾— (ä¸€éƒ¨å¤‰æ›´) ---
        const screens = { login: document.getElementById('login-screen'), setup: document.getElementById('setup-screen'), main: document.getElementById('main-app') };
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        // (ãã®ä»–ã€å¿…è¦ãªDOMè¦ç´ ã®å–å¾—ã¯çœç•¥)

        let currentUser = null; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒ
        let dailyRecords = {}; // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let userSettings = {};

        // --- ç”»é¢è¡¨ç¤ºã®ç®¡ç† ---
        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if(screens[screenName]) screens[screenName].classList.add('active');
        }

        // --- Firebase Authentication (ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–) ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ
                currentUser = user;
                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();

                if (userDoc.exists) {
                    // è¨­å®šæƒ…å ±ãŒã‚ã‚‹ -> ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
                    userSettings = userDoc.data().settings || {};
                    await loadRecordsFromFirestore();
                    showMainApp();
                } else {
                    // è¨­å®šæƒ…å ±ãŒãªã„ -> åˆæœŸè¨­å®šç”»é¢ã¸
                    showScreen('setup');
                }
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã‚‹å ´åˆ
                currentUser = null;
                showScreen('login');
            }
        });

        // --- æ–°è¦ç™»éŒ²å‡¦ç† ---
        signupBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                // ç™»éŒ²æˆåŠŸå¾Œã€onAuthStateChangedãŒè‡ªå‹•ã§ç™ºç«ã—ã€åˆæœŸè¨­å®šç”»é¢ã«é·ç§»ã™ã‚‹
            } catch (error) {
                alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        });

        // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã€onAuthStateChangedãŒè‡ªå‹•ã§ç™ºç«ã™ã‚‹
            } catch (error) {
                alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        });
        
        // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ---
        logoutBtn.addEventListener('click', () => {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                auth.signOut();
            }
        });

        // --- åˆæœŸè¨­å®šã®ä¿å­˜ ---
        const saveSetupBtn = document.getElementById('save-setup-btn');
        saveSetupBtn.addEventListener('click', async () => {
            const targetWeight = parseFloat(document.getElementById('target-weight').value);
            if (currentUser && targetWeight > 0) {
                const newSettings = { targetWeight: targetWeight };
                await db.collection('users').doc(currentUser.uid).set({ settings: newSettings });
                userSettings = newSettings;
                showMainApp();
            } else {
                alert('æœ‰åŠ¹ãªç›®æ¨™ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        });
        
        // --- Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ ---
        async function loadRecordsFromFirestore() {
            if (!currentUser) return;
            const recordsSnapshot = await db.collection('users').doc(currentUser.uid).collection('records').get();
            dailyRecords = {};
            recordsSnapshot.forEach(doc => {
                dailyRecords[doc.id] = doc.data();
            });
        }
        
        // --- ãƒ¡ã‚¤ãƒ³ç”»é¢ã®è¡¨ç¤ºã¨å†æç”» ---
        function showMainApp() { /* ... onAuthStateChangedã‹ã‚‰å‘¼ã°ã‚Œã‚‹ ... */ }
        function renderAll() { /* ... å†…éƒ¨ã§Firestoreã®ãƒ‡ãƒ¼ã‚¿(dailyRecords)ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ ... */ }

        // --- è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ä¿å­˜å‡¦ç† ---
        const recordForm = document.getElementById('record-form');
        recordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const date = document.getElementById('date-input').value;
            const recordData = {
                weight: document.getElementById('weight-input').value ? parseFloat(document.getElementById('weight-input').value) : null,
                didExercise: document.getElementById('exercise-check').checked,
                isPeriod: document.getElementById('period-check').checked,
                exerciseMemo: document.getElementById('exercise-memo').value.trim()
            };

            // Firestoreã«ä¿å­˜
            await db.collection('users').doc(currentUser.uid).collection('records').doc(date).set(recordData, { merge: true });
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ›´æ–°
            dailyRecords[date] = recordData;
            
            alert('è¨˜éŒ²ã—ã¾ã—ãŸï¼');
            renderAll();
            // checkAndAwardBadges(); // ãƒãƒƒã‚¸æ©Ÿèƒ½ã‚‚åŒæ§˜ã«Firestoreãƒ™ãƒ¼ã‚¹ã§å†å®Ÿè£…ãŒå¿…è¦
        });
        
        // (æ³¨ï¼šrenderHistory, renderChart, ãƒãƒƒã‚¸æ©Ÿèƒ½ãªã©ã®æç”»é–¢æ•°ã¯ã€
        // localStorageã§ã¯ãªãã€å¤‰æ•°`dailyRecords`, `userSettings`ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«
        // å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬çš„ãªè¦‹ãŸç›®ã¯åŒã˜ã§ã™)
        
        // (ãã®ä»–ã®ãƒœã‚¿ãƒ³ã‚„ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯çœç•¥)

    });
    </script>
</body>
</html>